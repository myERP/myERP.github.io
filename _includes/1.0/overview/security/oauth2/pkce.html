<div id="pkce" class="group">

    <h2>PKCE Flow</h2>

    <p>The OneUp Authorization Server supports authorization code flow with <a href="https://tools.ietf.org/html/rfc7636" target="_blank">Proof Key for Code Exchange (PKCE)</a></p>

    <p>In case you want to add additional security in the authorization flow, you can implement PKCE.</p>

    <p>The PKCE-enhanced Authorization Code Flow builds upon the standard Authorization Code Flow, so the steps are the same as described above.</p>

    <p>The difference is that your application should send more parameters when starting the authorization flow and when exchanging the authorization token.</p>

    <p>The following new parameters should be send when starting the flow:</p>

    <table class="table table-bordered table-striped">
        <thead>
        <tr>
            <th>Parameter</th>
            <th>Description</th>
        </tr>
        </thead>
        <tbody>
            <tr>
                <td>code_challenge</td>
                <td>The code challenge generated by your application</td>
            </tr>
            <tr>
                <td>code_challenge_method</td>
                <td>The method used to generate the code challenge<br>
                    The <code>plain</code> method does not change the input, so the value of <code>code_verifier</code> and the resultant value of <code>code_challenge</code> are equal<br>
                    The <code>S256</code> method computes the SHA-256 hash of the input and then encodes the hash value using Base64-URL<br>
                    When <code>code_challenge_method</code> parameter is omitted, the authorization server assumes <code>plain</code> as the default value
                </td>
            </tr>
        </tbody>
    </table>

{% highlight http %}
POST {{site.oauth2.endpoints.authorization.url}} HTTP/1.1
Host: {{ site.oauth2.domain }}
Content-Type: application/x-www-form-urlencoded

response_type=code
&client_id=xxxxxxxxxx
&redirect_uri=xxxxxxxxxx
&scope=offline
&code_challenge=xxxxxxxxxx
&code_challenge_method=S256
&state=xxxxxxxxxx
{% endhighlight %}

{% highlight bash %}
curl -D- --request POST '{{site.oauth2.protocol}}://{{ site.oauth2.domain }}{{site.oauth2.endpoints.authorization.url}}' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'response_type=code' \
--data-urlencode 'client_id=xxxxxxxxxx' \
--data-urlencode 'redirect_uri=xxxxxxxxxx' \
--data-urlencode 'scope=offline' \
--data-urlencode 'code_challenge=xxxxxxxxxx' \
--data-urlencode 'code_challenge_method=S256' \
--data-urlencode 'state=xxxxxxxxxx'
{% endhighlight %}

    <p>The authorization server will save the <code>code_challenge</code> and <code>code_challenge_method</code> to later verify a token request from the client application.

    <p>The response from the authorization endpoint has nothing special for PKCE. Itâ€™s a normal response as usual, however the following parameter must be send when exchanging the authentication code:</p>

    <table class="table table-bordered table-striped">
        <thead>
        <tr>
            <th>Parameter</th>
            <th>Description</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>code_verifier</td>
            <td>The code verifier used to generate the <code>code_challenge</code></td>
        </tr>
        </tbody>
    </table>

{% highlight http %}
POST {{site.oauth2.endpoints.token.url}} HTTP/1.1
Host: {{ site.oauth2.domain }}
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&client_id=xxxxxxxxxx
&client_secret=xxxxxxxxxx
&code=xxxxxxxxxx
&code_verifier=xxxxxxxxxx
&redirect_uri=xxxxxxxxxx
{% endhighlight %}

{% highlight bash %}
curl -D- --request POST '{{site.oauth2.protocol}}://{{ site.oauth2.domain }}{{site.oauth2.endpoints.token.url}}' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=authorization_code' \
--data-urlencode 'client_id=xxxxxxxxxx' \
--data-urlencode 'client_secret=xxxxxxxxxx' \
--data-urlencode 'code=xxxxxxxxxx' \
--data-urlencode 'code_verifier=xxxxxxxxxx' \
--data-urlencode 'redirect_uri=xxxxxxxxxx'
{% endhighlight %}

    <p>The authorization server will verify if the two code challenges' are equal, if the codes are verified, the authorization server issues an access token as usual.</p>
</div>